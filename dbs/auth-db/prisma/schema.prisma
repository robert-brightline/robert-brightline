datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client"
  output   = "../src/prisma"
}

generator zod {
  provider = "zod"
  output   = "../src/zod"
}

enum Operation {
  READ
  WRITE
  UPDATE
  DELETE
  MANAGE
  TRIGGER
  NOTIFY
  APPROVE
  START
  STOP
  RESTART

  REJECT
  SUBMIT
  ARCHIVE
  RESTORE
  EXPORT
  IMPORT
  GRANT
  REVOKE
  LOCK
  UNLOCK
  SYNC
  DEPLOY
  ROLLBACK
}

model AuditLog {
  id        Int       @id @default(autoincrement())
  createdAt DateTime  @default(now())
  subject   String
  message   String?
  operation Operation
  operator  String    @db.Uuid
}

model App {
  id          Int          @id @default(autoincrement())
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  deletedAt   DateTime?
  name        String       @unique @db.VarChar(255)
  permissions Permission[]
}

model Resource {
  id          Int          @id @default(autoincrement())
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  deletedAt   DateTime?
  name        String       @unique @db.VarChar(255)
  permissions Permission[]
}

model Role {
  id        Int       @id @default(autoincrement())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  name String @unique @db.VarChar(255)

  rolePermissions RolePermissions[]
  userRoles       UserRole[]
}

model RolePermissions {
  id        Int       @id @default(autoincrement())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  role   Role @relation(fields: [roleId], references: [id])
  roleId Int

  permission   Permission @relation(fields: [permissionId], references: [id])
  permissionId Int

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

model Permission {
  id        Int       @id @default(autoincrement())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  operation Operation

  app   App @relation(fields: [appId], references: [id])
  appId Int

  resource   Resource @relation(fields: [resourceId], references: [id])
  resourceId Int

  rolePermissions        RolePermissions[]
  accessTokenPermissions AccessTokenPermissions[]

  @@unique([operation, appId, resourceId])
  @@index([operation])
  @@index([appId])
  @@index([resourceId])
}

model User {
  id        Int       @id @default(autoincrement())
  uuid      String    @unique @default(uuid(7))
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  /// @email 
  username String @unique @db.VarChar(255)

  /// @password
  password String

  userRoles UserRole[]
}

model UserRole {
  id        Int       @id @default(autoincrement())
  uuid      String    @unique @default(uuid(7))
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  user   User @relation(fields: [userId], references: [id])
  userId Int

  role   Role @relation(fields: [roleId], references: [id])
  roleId Int

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
}

model AccessToken {
  id        Int       @id @default(autoincrement())
  uuid      String    @unique @default(uuid(7))
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  name String @unique @db.VarChar(255)

  token String @unique

  accessTokenPermissions AccessTokenPermissions[]
}

model AccessTokenPermissions {
  id        Int       @id @default(autoincrement())
  uuid      String    @unique @default(uuid(7))
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  accessToken   AccessToken @relation(fields: [accessTokenId], references: [id])
  accessTokenId Int

  permission   Permission @relation(fields: [permissionId], references: [id])
  permissionId Int

  @@unique([accessTokenId, permissionId])
  @@index([accessTokenId])
  @@index([permissionId])
}

datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client"
  output   = "../src/prisma"
}

generator zod {
  provider = "zod"
  output   = "../src/zod"
}

model App {
  id        Int       @id @default(autoincrement())
  uuid      String    @default(uuid(7))
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  name        String  @unique @db.VarChar(255)
  version     String?
  description String?

  /// @internal
  permissions Permission[]

  /// @internal
  resources Resource[]

  @@unique([id, name])
}

model Resource {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  name    String @unique @map("resourceName") @db.VarChar(255)
  appName String
  appId   Int

  /// @internal
  app App @relation(fields: [appId, appName], references: [id, name])

  /// @internal
  permissions Permission[]

  @@unique([id, appId, appName, name])
  @@unique([id, name])
}

model Role {
  id        Int       @id @default(autoincrement())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  name String @unique @db.VarChar(255)

  /// @internal 
  rolePermissions RolePermissions[]

  @@unique([id, name])
}

model RolePermissions {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  appName       String
  appId         Int
  roleName      String
  roleId        Int
  resourceName  String
  resourceId    Int
  operationName String
  permissionId  Int

  role Role @relation(fields: [roleId, roleName], references: [id, name])

  permission Permission @relation(fields: [appId, resourceId, permissionId, appName, resourceName, operationName], references: [appId, resourceId, id, appName, resourceName, operationName])

  @@unique([permissionId, appName, resourceName, operationName])
  @@index([roleName])
  @@index([operationName])
  @@index([appName])
  @@index([resourceName])
  @@index([permissionId])
}

model Permission {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  appId         Int
  resourceId    Int
  appName       String
  resourceName  String
  operationName String

  app      App      @relation(fields: [appId, appName], references: [id, name])
  resource Resource @relation(fields: [resourceId, resourceName], references: [id, name])

  /// @internal 
  rolePermissions RolePermissions[]

  /// @internal 
  accessTokenPermissions SessionPermission[]

  /// @internal 
  userPermissions UserPermission[]

  @@unique([id, appId, resourceId, appName, resourceName, operationName])
  @@unique([id, appName, operationName, resourceName])
  @@index([appName])
  @@index([resourceName])
  @@index([operationName])
}

model User {
  id        Int       @id @default(autoincrement())
  uuid      String    @unique @default(uuid(7))
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  username String @unique @db.VarChar(255)
  password String

  /// @internal
  userPermissions UserPermission[]

  /// @internal 
  sessions Session[]
}

model UserPermission {
  id        Int       @id @default(autoincrement())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  user   User @relation(fields: [userId], references: [id])
  userId Int

  permission   Permission @relation(fields: [permissionId], references: [id])
  permissionId Int

  @@unique([userId, permissionId])
  @@index([userId])
  @@index([permissionId])
}

model Session {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  username String
  token    String @unique
  version  Int    @default(1)

  deviceId   String? @db.Uuid
  deviceType String?
  longitude  String?
  latitude   String?

  user User @relation(fields: [username], references: [username])

  sessionPermissions SessionPermission[]

  @@unique([username, token, version])
  @@unique([username, deviceId])
}

model SessionPermission {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  session   Session @relation(fields: [sessionId], references: [id])
  sessionId Int

  permission    Permission @relation(fields: [permissionId, appName, operationName, resourceName], references: [id, appName, operationName, resourceName])
  permissionId  Int
  appName       String
  operationName String
  resourceName  String

  @@unique([sessionId, permissionId, appName, operationName, resourceName])
  @@index([sessionId])
  @@index([permissionId])
  @@index([appName])
  @@index([operationName])
  @@index([resourceName])
}

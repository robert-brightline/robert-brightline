datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client"
  output   = "../src/prisma"
}

generator zod {
  provider = "zod"
  output   = "../src/zod"
}

enum Operation {
  READ
  WRITE
  UPDATE
  DELETE
  MANAGE
}

/// @internal 
model AuditLog {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  operation  Operation
  operatorId String    @db.Uuid
  subject    String
  message    String?
}

model App {
  id        Int       @id @default(autoincrement())
  uuid      String    @default(uuid(7))
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  name        String  @unique @db.VarChar(255)
  version     String?
  description String?

  // @internal
  permissions Permission[]

  /// @internal
  resources Resource[]
}

model Resource {
  id        Int       @id @default(autoincrement())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  name String @unique @db.VarChar(255)

  app   App @relation(fields: [appId], references: [id])
  appId Int

  // @internal
  permissions Permission[]
}

model Role {
  id        Int       @id @default(autoincrement())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  name String @unique @db.VarChar(255)

  /// @internal 
  rolePermissions RolePermissions[]
}

model RolePermissions {
  id        Int       @id @default(autoincrement())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  role   Role @relation(fields: [roleId], references: [id])
  roleId Int

  permission   Permission @relation(fields: [permissionId], references: [id])
  permissionId Int

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

model Permission {
  id        Int       @id @default(autoincrement())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  operation Operation

  app   App @relation(fields: [appId], references: [id])
  appId Int

  resource   Resource @relation(fields: [resourceId], references: [id])
  resourceId Int

  /// @internal 
  rolePermissions RolePermissions[]

  /// @internal 
  accessTokenPermissions TokenPermission[]

  /// @internal 
  userPermissions UserPermission[]

  @@unique([operation, appId, resourceId])
  @@index([operation])
  @@index([appId])
  @@index([resourceId])
}

model User {
  id        Int       @id @default(autoincrement())
  uuid      String    @unique @default(uuid(7))
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  username String @unique @db.VarChar(255)
  password String

  /// @internal 
  tokenVersion Int @default(1)

  otp String?

  /// @internal
  userPermissions UserPermission[]

  /// @internal
  permissions String?
}

model UserPermission {
  id        Int       @id @default(autoincrement())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  user   User @relation(fields: [userId], references: [id])
  userId Int

  permission   Permission @relation(fields: [permissionId], references: [id])
  permissionId Int

  @@unique([userId, permissionId])
  @@index([userId])
  @@index([permissionId])
}

model Token {
  id        Int       @id @default(autoincrement())
  uuid      String    @unique @default(uuid(7))
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  name    String @unique @db.VarChar(255)
  token   String @unique
  version Int    @default(1)

  tokenPermissions TokenPermission[]
}

model TokenPermission {
  id        Int       @id @default(autoincrement())
  uuid      String    @unique @default(uuid(7))
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  token   Token @relation(fields: [tokenId], references: [id])
  tokenId Int

  permission   Permission @relation(fields: [permissionId], references: [id])
  permissionId Int

  @@unique([tokenId, permissionId])
  @@index([tokenId])
  @@index([permissionId])
}
